<%
  # Template for a cubicle island, which has 4 desks.
  #
  # Adds furniture if needed.
  #
  # Required variables
  # * $pi (number) Math::PI
  # * $count (number) For unique names
  # * $pose (number[6]) Pose of island center
  # * $floorplan (boolean) True if only showing floorplan, so computer and chair
  #                        are hidden.

  $count += 1

  top = 0.76
%>
  <model name="cubicle_island_<%= $count %>">
    <static>true</static>
    <pose>
      <%= $pose[0] %>
      <%= $pose[1] %>
      <%= $pose[2] %>
      <%= $pose[3] %>
      <%= $pose[4] %>
      <%= $pose[5] %>
    </pose>
    <link name="link">
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>model://cubicle_island/meshes/cubicle_island.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://cubicle_island/meshes/cubicle_island.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>

<%
  if not $floorplan
%>
    <%
      # offset if computer is on the far end
      far_off = 1.22

      # offset if computer is on the near end
      near_off = 0.45

      for x in [-1, 1]
        for y in [-1, 1]

          # placement axis
          p = ['X', 'Y'].sample

          if p == 'X'
            comp_x = far_off * x
            comp_y = near_off * y
            comp_yaw = y > 0 ? $pi : 0.0
          else
            comp_x = near_off * x
            comp_y = far_off * y
            comp_yaw = x > 0 ? $pi * 0.5 : -$pi * 0.5
          end
    %>
      <include>
        <pose>
          <%= comp_x %>
          <%= comp_y %>
          <%= top %>
          0
          0
          <%= comp_yaw %>
        </pose>
        <uri>model://computer</uri>
      </include>

      <%
         chair_x = (rand(1.13..2.0)) * x
         chair_y = (rand(1.13..2.0)) * y

          if x < 0 and y < 0
            chair_yaw = $pi * 0.75 + rand(-0.7..0.7)
          elsif x < 0 and y > 0
            chair_yaw = $pi * 0.25 + rand(-0.7..0.7)
          elsif x > 0 and y < 0
            chair_yaw = -$pi * 0.75 + rand(-0.7..0.7)
          elsif x > 0 and y > 0
            chair_yaw = -$pi * 0.25 + rand(-0.7..0.7)
          end
      %>
      <include>
        <pose>
          <%= chair_x %>
          <%= chair_y %>
          0
          0
          0
          <%= chair_yaw %>
        </pose>
        <uri>model://office_chair</uri>
      </include>
      <% end %>
    <% end %>
<%
  end # if not $floorplan
%>

</model>
