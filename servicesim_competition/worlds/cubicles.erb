<%
  # Cubicles template
  #
  # Required variables
  # * $count (number)
  # * $cubicle_size (number) row count
  # * $cubicle_pos (number[]) start position

  # Unit size of a cubicle element
  cubicle_u = 0.6

  # Size of corner elements
  cubicle_corner = 0.025

  x_size = 3

  center_y = $cubicle_pos[1]
  x_min = 0
  x_max = x_size * $cubicle_size - 1

  count = 0
%>
<model name="cubicles_<%= $count.to_s() %>">

  <static>true</static>

  <pose>
    <%= $cubicle_pos[0] %>
    <%= $cubicle_pos[1] %>
    <%= $cubicle_pos[2] %>
    0.0
    0.0
    0.0
  </pose>

  <link name="walls">

    <!-- center wall -->
    <%
      for x in (x_min..x_max)
        count += 1
        type = 'closed'
        offset = -0.3
        pose =
        [
          x * cubicle_u + offset,
          0.0,
          0.0,
          0.0,
          0.0,
          0.0
        ]
    %>
      <visual name="visual_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
      <collision name="collision_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
    <% end %>

    <!-- row divisions -->
    <%
      for x in (x_min..(x_max+1)).step(x_size)

        for side in [-1, 1]

          count += 1
          type = 'wall'
          offset = -0.9 * side
          pose =
          [
            x * cubicle_u,
            offset,
            0.0,
            0.0,
            0.0,
            Math::PI * 0.5 * side
          ]
    %>
      <visual name="visual_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
      <collision name="collision_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
      <% end %>
    <% end %>

    <!-- openings -->
    <%
      for x in (x_min..(x_max+1)).step(x_size)

        for side in [-1, 1]

          if side == 1 and x == x_min
            next
          elsif side == -1 and x == x_max + 1
            next
          end

          count += 1
          type = 'wall'
          offset = -0.9 * side
          yaw = side == -1 ? 0.0 : Math::PI
          pose =
          [
            x * cubicle_u + offset,
           - (2 * cubicle_u + cubicle_corner) * side,
            0.0,
            0.0,
            0.0,
            yaw
          ]
    %>
      <visual name="visual_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
      <collision name="collision_<%= count %>">

        <pose>
          <%= pose[0] %>
          <%= pose[1] %>
          <%= pose[2] %>
          <%= pose[3] %>
          <%= pose[4] %>
          <%= pose[5] %>
        </pose>

        <geometry>
          <mesh>
            <uri>model://cubicle_wall/meshes/cubicle_<%= type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
      <% end %>
    <% end %>

  </link>

  <!-- furniture -->
  <%
    for x in (x_min..x_max).step(x_size)

      for side in [-1, 1]

        count += 1
        x_off = 0.8
        x_off_chair = x_off + rand(-0.1..0.1)
        y_off = -0.4 * side
        y_off_chair = -0.7 * side
        yaw = side == -1 ? 0.0 : Math::PI
        yaw_comp = side == -1 ? Math::PI : 0.0
  %>
    <include>
      <name>desk_<%= count %></name>
      <pose>
        <%= x * cubicle_u + x_off %>
        <%= y_off %>
        0.1
        0
        0
        <%= yaw %>
      </pose>
      <uri>model://desk</uri>
    </include>
    <include>
      <name>computer_<%= count %></name>
      <pose>
        <%= x * cubicle_u + x_off %>
        <%= y_off %>
        0.78
        0
        0
        <%= yaw_comp %>
      </pose>
      <uri>model://computer</uri>
    </include>
    <include>
      <name>chair_<%= count %></name>
      <pose>
        <%= x * cubicle_u + x_off_chair %>
        <%= y_off_chair %>
        0
        0
        0
        <%= yaw + rand(-0.4..0.4) %>
      </pose>
      <uri>model://office_chair</uri>
    </include>
    <% end %>
  <% end %>

</model>
