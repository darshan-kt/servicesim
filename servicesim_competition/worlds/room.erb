<%
  # Room template
  #
  # Required variables
  # * $o (number) length of an office unit
  # * $room_type (string)
  # * $room_name (string)
  # * $room_floor (string)
  # * $room_pose (array[6])
  # * $room_size (array[4]) in office units, [min_x, max_x, min_y, max_y]
  # * $door_angle (number)

  off_x = -$o * 0.5
%>

<model name="<%= $room_name %>">

  <static>true</static>

  <pose>
    <%= $room_pose[0] %>
    <%= $room_pose[1] %>
    <%= $room_pose[2] %>
    <%= $room_pose[3] %>
    <%= $room_pose[4] %>
    <%= $room_pose[5] %>
  </pose>

  <link name="link">
    <collision name="collision">
      <geometry>
        <mesh>
          <uri>file://media/meshes/<%= $room_type %>.obj</uri>
          <scale>0.01 0.01 0.01</scale>
        </mesh>
      </geometry>
    </collision>
    <visual name="visual">
      <geometry>
        <mesh>
          <uri>file://media/meshes/<%= $room_type %>.obj</uri>
          <scale>0.01 0.01 0.01</scale>
        </mesh>
      </geometry>
    </visual>

    <!-- floor -->
    <%
      for x in ($room_size[0]..$room_size[1])
        for y in ($room_size[2]..$room_size[3])
    %>
      <visual name="floor_<%= x %>_<%= y %>">

        <pose>
          <%= x * $o %>
          <%= y * $o %>
          0
          0
          0
          0
        </pose>

        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_floor %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    <%
        end
      end
    %>

  </link>

  <%
    if $door_angle == 0.0
  %>
    <link name="closed_door">
      <pose><%= -$o * 0.5 %> 0 0 0 0 0</pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://door/meshes/door.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>

  <% else %>

    <link name="door_frame">
      <pose><%= off_x %> 0 0 0 0 0</pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://door/meshes/door_frame.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>
    <link name="door">
      <pose>-1.22 0.15 0 0 0 <%= $door_angle %></pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <pose>0.45 -0.15 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://door/meshes/door_door.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>
  <% end %>

</model>
