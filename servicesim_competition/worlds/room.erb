<%
  # Room template
  #
  # Required variables
  # * $o (number) length of an office unit
  # * $pi (number)
  # * $room_type (string) must correspond to an obj mesh
  # * $room_name (string) unique name for room
  # * $room_floor (string) must correspond to an obj mesh
  # * $room_pose (number[6])
  # * $room_size (number[4]) in office units, [min_x, max_x, min_y, max_y]
  # * $door_angle (number)
  # * $floorplan (boolean) true if only showing floorplan

  off_x = -$o * 0.5
  height = 2 * $o
  thickness = $g

  door_side = 0.24

  min_x = $room_size[0]
  max_x = $room_size[1]
  min_y = $room_size[2]
  max_y = $room_size[3]
%>

<model name="<%= $room_name %>">

  <static>true</static>

  <pose>
    <%= $room_pose[0] %>
    <%= $room_pose[1] %>
    <%= $room_pose[2] %>
    <%= $room_pose[3] %>
    <%= $room_pose[4] %>
    <%= $room_pose[5] %>
  </pose>

  <link name="link">

    <%
      width = max_x * $o + door_side
      if width != 0.0
    %>
    <collision name="right_of_door">

      <pose>
        <%= width * 0.5 - door_side %>
        <%= thickness * 0.5 %>
        <%= height * 0.5 %>
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= width %>
            <%= thickness %>
            <%= height %>
          </size>
        </box>
      </geometry>
    </collision>
    <% end %>

    <%
      width = -min_x * $o + door_side
      if width != 0.0
    %>
    <collision name="left_of_door">

      <pose>
        <%= -$o - width * 0.5 + door_side %>
        <%= thickness * 0.5 %>
        <%= height * 0.5 %>
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= width %>
            <%= thickness %>
            <%= height %>
          </size>
        </box>
      </geometry>
    </collision>
    <% end %>

    <%
      width = $o
      h = 0.9
      if width != 0.0
    %>
    <collision name="top_of_door">

      <pose>
        <%= -width * 0.5 %>
        <%= thickness * 0.5 %>
        2.55
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= width %>
            <%= thickness %>
            <%= h %>
          </size>
        </box>
      </geometry>
    </collision>
    <% end %>

    <%
      width = (max_y - min_y + 1) * $o
    %>
    <collision name="right">

      <pose>
        <%= max_x * $o + thickness * 0.5 %>
        <%= -width * 0.5 %>
        <%= height * 0.5 %>
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= thickness %>
            <%= width %>
            <%= height %>
          </size>
        </box>
      </geometry>
    </collision>
    <collision name="left">

      <pose>
        <%= (min_x - 1) * $o - thickness * 0.5 %>
        <%= -width * 0.5 %>
        <%= height * 0.5 %>
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= thickness %>
            <%= width %>
            <%= height %>
          </size>
        </box>
      </geometry>
    </collision>

    <%
      width = (max_x - min_x + 1) * $o
    %>
    <collision name="back">

      <pose>
        <%= width * 0.5 + (min_x - 1) * $o %>
        <%= (min_y - 1) * $o - thickness * 0.5 %>
        <%= height * 0.5 %>
        0
        0
        0
      </pose>

      <geometry>
        <box>
          <size>
            <%= width %>
            <%= thickness %>
            <%= height %>
          </size>
        </box>
      </geometry>
    </collision>

    <visual name="visual">
      <geometry>
        <mesh>
          <uri>file://media/meshes/<%= $room_type %>.obj</uri>
          <scale>0.01 0.01 0.01</scale>
        </mesh>
      </geometry>
    </visual>

    <!-- floor -->
    <%
      for x in (min_x..max_x)
        for y in (min_y..max_y)
    %>
      <visual name="floor_<%= x %>_<%= y %>">

        <pose>
          <%= x * $o %>
          <%= y * $o %>
          0
          0
          0
          0
        </pose>

        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_floor %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    <%
        end
      end
    %>

  </link>

<%
  if not $floorplan
%>
  <%
    if $door_angle == 0.0
  %>
    <link name="closed_door">
      <pose><%= -$o * 0.5 %> 0 0 0 0 0</pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://door/meshes/door.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>

  <% else %>

    <link name="door_frame">
      <pose><%= off_x %> 0 0 0 0 0</pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <geometry>
          <mesh>
            <uri>model://door/meshes/door_frame.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>
    <link name="door">
      <pose>-1.22 0.15 0 0 0 <%= $door_angle %></pose>
  <!-- TODO
      <collision name="collision">
        <geometry>
          <mesh>
            <uri>file://media/meshes/<%= $room_type %>.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </collision>
  -->
      <visual name="visual">
        <pose>0.45 -0.15 0 0 0 0</pose>
        <geometry>
          <mesh>
            <uri>model://door/meshes/door_door.obj</uri>
            <scale>0.01 0.01 0.01</scale>
          </mesh>
        </geometry>
      </visual>
    </link>
  <% end %>

  <!-- Furniture -->

  <% if $room_type == 'meeting_room_large' %>
  <include>
    <pose>
      <%= 1.15*$o %>
      <%= -2*$o %>
      0
      0
      0
      0
    </pose>
    <uri>model://conference_table_large</uri>
  </include>
  <include>
    <pose>
      <%= -$o %>
      <%= -3*$o %>
      0
      0
      0
      <%= $pi*0.75 + rand(-0.2..0.2) %>
    </pose>
    <uri>model://whiteboard</uri>
  </include>
  <%
    for x in (0..4)
      for y in [-1.6*$o, -1*$o]
        yaw = y == -1 * $o ? 0.0 : $pi
        yaw += rand(-0.15..0.15)
        y += rand(-0.05..0.05)
  %>
      <include>
        <name>chair_<%= x %>_<%= y %></name>
        <pose>
          <%= x * $o * 0.6 %>
          <%= y * $o %>
          0
          0
          0
          <%= yaw %>
        </pose>
        <uri>model://desk_chair</uri>
      </include>
      <% end %>
    <% end %>
  <% end %>

  <% if $room_type == 'meeting_room_small' %>
  <include>
    <pose>
      <%= 0.3*$o %>
      <%= -1.4*$o %>
      0
      0
      0
      0
    </pose>
    <uri>model://conference_table_small</uri>
  </include>
  <include>
    <pose>
      <%= -1.5*$o %>
      <%= -1.4*$o %>
      0
      0
      0
      <%= $pi*0.5 %>
    </pose>
    <uri>model://whiteboard</uri>
  </include>
  <%
    for x in (0..2)
      for y in [-1.2*$o, -0.6*$o]
        yaw = y == -0.7 * $o ? 0.0 : $pi
        yaw += rand(-0.15..0.15)
        y += rand(-0.05..0.05)
  %>
      <include>
        <name>chair_<%= x %>_<%= y %></name>
        <pose>
          <%= x * $o * 0.6 - 0.15 %>
          <%= y * $o %>
          0
          0
          0
          <%= yaw %>
        </pose>
        <uri>model://desk_chair</uri>
      </include>
      <% end %>
    <% end %>
  <% end %>

  <% if $room_type == 'bathroom' %>
  <include>
    <pose>
      -0.6
      -2.1
      0
      0
      0
      <%= $pi %>
    </pose>
    <uri>model://toilet</uri>
  </include>
  <% end %>

  <% if $room_type == 'office_large' %>

  <include>
    <pose>
      <%= -1.6*$o %>
      -0.4
      0
      0
      0
      0
    </pose>
    <uri>model://mini_fridge</uri>
  </include>

  <%
    $pose =
    [
      2 * $o,
      -3 * $o,
      0,
      0,
      0,
      -$pi * 0.5,
    ]
  %>
  <%= fromFile(DIR + "/cubicle_corner.erb") %>

  <%
    $pose =
    [
      -2 * $o,
      -3 * $o,
      0,
      0,
      0,
      $pi,
    ]
  %>
  <%= fromFile(DIR + "/cubicle_corner.erb") %>

  <%
    $pose =
    [
      2 * $o,
      0,
      0,
      0,
      0,
      0,
    ]
  %>
  <%= fromFile(DIR + "/cubicle_corner.erb") %>

  <% end %>

<%
  end # if not $floorplan
%>

</model>

